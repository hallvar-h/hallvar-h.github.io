<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of closedLoopD42</title>
  <meta name="keywords" content="closedLoopD42">
  <meta name="description" content="">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../index.html">Home</a> &gt;  <a href="../index.html">STAS-WPP</a> &gt; <a href="index.html">STAS-Test</a> &gt; closedLoopD42.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../index.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for STAS-WPP\STAS-Test&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>closedLoopD42
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong></strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>This is a script file. </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment"></pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="../../STAS-WPP/STAS-Aeroelastic/MBCindices_Ndj.html" class="code" title="function [b1,b2,b3] = MBCindices_Ndj (Ndj,idofs)">MBCindices_Ndj</a>	</li>
<li><a href="../../STAS-WPP/STAS-Aeroelastic/assemblePin.html" class="code" title="function Pin = assemblePin (s)">assemblePin</a>	Version:        Changes:</li>
<li><a href="../../STAS-WPP/STAS-Aeroelastic/basicTransforms.html" class="code" title="function [Tn_y,Th_d,Tb_h] = basicTransforms (delta,phi)">basicTransforms</a>	This builds the basic 3-by-3 transform matrices,</li>
<li><a href="../../STAS-WPP/STAS-Aeroelastic/dTdth.html" class="code" title="function [T,dT] = dTdth (th)">dTdth</a>	</li>
<li><a href="../../STAS-WPP/STAS-Aeroelastic/getDOFRefs.html" class="code" title="function [idofs,idofm,inods,inodm,Ndof] = getDOFRefs (s)">getDOFRefs</a>	</li>
<li><a href="../../STAS-WPP/STAS-Aeroelastic/getmdofRefs.html" class="code" title="function [imdofs,Nmd] = getmdofRefs (s)">getmdofRefs</a>	</li>
<li><a href="../../STAS-WPP/STAS-Aeroelastic/undeformedPosition.html" class="code" title="function [qB0,Pn0_B,Ts0_B,TB0_g] =undeformedPosition (Pin,yaw,tilt,azimuth,cone,pitch,edx,idofs,idofm,inods,inodm)">undeformedPosition</a>	</li>
<li><a href="../../STAS-WPP/STAS-Electric/inductance.html" class="code" title="function [L,dL] = inductance (I0,L0,II)">inductance</a>	</li>
<li><a href="../../STAS-WPP/STAS-Main/SSDiscreteTime.html" class="code" title="function [A,B,dt] = SSDiscreteTime (meth,aa,bb,dti)">SSDiscreteTime</a>	</li>
<li><a href="../../STAS-WPP/STAS-Main/Ytransform.html" class="code" title="function [A,B,C,Phi,slap] = Ytransform (aa,bb,cc)">Ytransform</a>	</li>
<li><a href="getPsia.html" class="code" title="function Psia = getPsia (modalAero,s,a,azi,q,qd,P,shape0)">getPsia</a>	</li>
<li><a href="modalTransformation.html" class="code" title="function [Am,Bm,Cm] = modalTransformation (A,B,C,freqs,tol,Yflg,wrtflg)">modalTransformation</a>	</li>
<li><a href="modelReduction.html" class="code" title="function [Ar,Br,Cr,Dr] = modelReduction (A,B,C,D,freqs,tol)">modelReduction</a>	</li>
<li><a href="../../STAS-WPP/STAS-Utilities/MBC.html" class="code" title="function [TpsiB,TBpsi] = MBC (N,b1,b2,b3,psi)">MBC</a>	</li>
<li><a href="../../STAS-WPP/STAS-Utilities/TFromTheta.html" class="code" title="function T = TFromTheta (th)">TFromTheta</a>	</li>
<li><a href="../../STAS-WPP/STAS-Utilities/eigVal.html" class="code" title="function [slap,shp,ifrq] = eigVal (A)">eigVal</a>	</li>
<li><a href="../../STAS-WPP/STAS-Utilities/eigVal_silent.html" class="code" title="function [slap,shp,ifrq] = eigVal_silent (A)">eigVal_silent</a>	</li>
<li><a href="../../STAS-WPP/STAS-Utilities/getLTMnorms.html" class="code" title="function [length,time,mass,current,voltage,velocity,force,power,stress,ndens,nvisc,stiffness,damping,resistance,inductance,capacitance,flux] = getLTMnorms (fname)">getLTMnorms</a>	</li>
<li><a href="../../STAS-WPP/STAS-Utilities/partitionMatrix.html" class="code" title="function [Mp,rr,cr] = partitionMatrix (M,rDOFs,cDOFs)">partitionMatrix</a>	</li>
</ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
</ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 
0002 clear;
0003 
0004 pkg load control;
0005 
0006 [length,time,mass,current,voltage,              <span class="keyword">...</span>
0007  velocity,force,power,stress,density,viscosity, <span class="keyword">...</span>
0008  stiffness,damping,resistance,<a href="../../STAS-WPP/STAS-Electric/inductance.html" class="code" title="function [L,dL] = inductance (I0,L0,II)">inductance</a>,       <span class="keyword">...</span>
0009  capacitance,flux] = <a href="../../STAS-WPP/STAS-Utilities/getLTMnorms.html" class="code" title="function [length,time,mass,current,voltage,velocity,force,power,stress,ndens,nvisc,stiffness,damping,resistance,inductance,capacitance,flux] = getLTMnorms (fname)">getLTMnorms</a> (<span class="string">'LTMnorms.txt'</span>);
0010 
0011 nm = <span class="string">'DTU10MW'</span>;
0012 inpnm = <span class="string">'_P060_'</span>;
0013 convertToAeroModes = 0;
0014 
0015 Vmag = 10                                   / velocity;
0016 thV = 0;
0017 Vg0 = [Vmag*cos(thV); Vmag*sin(thV); 0];
0018 dens = 1.225                                / density;
0019 Area = pi*(89.15^2)                         / length^2;
0020 CPstar = 0.48;
0021 
0022 yaw = 0;
0023 betas = [0;0;0];
0024 azi = 0;
0025 cp0 = cos(azi);
0026 sp0 = sin(azi);
0027 
0028 Tpw = 6                                     / time;
0029 Hsw = 2                                     / length;
0030 wang = 0;
0031 fw = 1/Tpw;
0032 aw = 2*pi*fw;
0033 zetw = 0.1;
0034 atw = 0.01*(2*pi)                           * time;
0035 Fw0 = 1.e6*[cos(wang), sin(wang)].'         / force;
0036 
0037 aV = 0.05*(2*pi);
0038 <span class="comment">% a3P computed based on W.</span>
0039 zet3P = 0.1;
0040 
0041 fco = 2.0                                   * time;  <span class="comment">% &gt; fco solved as static.</span>
0042 dt = 0.05                                   / time;  <span class="comment">% Set to -1 for auto.</span>
0043 
0044 Nf = 2^12;  <span class="comment">% = 4*nnf, that is, 4 times the number of analysis frequencies.</span>
0045 df = 0.001                                  * time;
0046 
0047 freqs = df*[[0:Nf/2-1] [-Nf/2:-1]].';
0048 
0049 eval([<span class="string">'[s,a] = STASTurbine_'</span>  nm <span class="string">' ();'</span>]);
0050 eval([<span class="string">'epar  = STASElectric_'</span> nm <span class="string">' ();'</span>]);
0051 eval([<span class="string">'ppar  = STASPitch_'</span>    nm <span class="string">' ();'</span>]);
0052 eval([<span class="string">'ypar  = STASYaw_'</span>      nm <span class="string">' ();'</span>]);
0053 eval([<span class="string">'c     = STASControl_'</span>  nm <span class="string">' ();'</span>]);
0054 eval([<span class="string">'m     = STASSensor_'</span>   nm <span class="string">' ();'</span>]);
0055 
0056 a.dens = 1.225                     / density;
0057 a.visc = 1.789e-5                  / viscosity;
0058 grav   = [0;0;0];  <span class="comment">% Consistent with asymWind, gravity is implemented as</span>
0059                    <span class="comment">% an external force rather than part of the matrices.</span>
0060 
0061 vs     = [33000;0]                 / voltage;    <span class="comment">% Grid electrical voltage.</span>
0062 we     = 50*(2*pi)                 * time;       <span class="comment">% Grid electrical frequency.</span>
0063 th_e   = 0;                                      <span class="comment">% Ref. elec. angle.</span>
0064 Vhdc   = c.Vhdc;                                 <span class="comment">% DC link voltage command.</span>
0065 Qh     = 0                         / power;      <span class="comment">% Reactive power command.</span>
0066 
0067 [idofs,idofm,inods,inodm,Ndof] = <a href="../../STAS-WPP/STAS-Aeroelastic/getDOFRefs.html" class="code" title="function [idofs,idofm,inods,inodm,Ndof] = getDOFRefs (s)">getDOFRefs</a> (s);
0068 [imdofs,Nmd] = <a href="../../STAS-WPP/STAS-Aeroelastic/getmdofRefs.html" class="code" title="function [imdofs,Nmd] = getmdofRefs (s)">getmdofRefs</a> (s);
0069 Ndj = Ndof + 6;
0070 Nnod = Ndof/6;
0071 
0072 Pin = <a href="../../STAS-WPP/STAS-Aeroelastic/assemblePin.html" class="code" title="function Pin = assemblePin (s)">assemblePin</a> (s);
0073 [q,P,Ts0_B,TB0_g] =                                                     <span class="keyword">...</span>
0074       <a href="../../STAS-WPP/STAS-Aeroelastic/undeformedPosition.html" class="code" title="function [qB0,Pn0_B,Ts0_B,TB0_g] =undeformedPosition (Pin,yaw,tilt,azimuth,cone,pitch,edx,idofs,idofm,inods,inodm)">undeformedPosition</a> (Pin,yaw,s.nacelle.delta,azi,s.driveshaft.phi, <span class="keyword">...</span>
0075                           betas,0,idofs,idofm,inods,inodm);
0076 [Tn_y,Th_d,Tb_h] = <a href="../../STAS-WPP/STAS-Aeroelastic/basicTransforms.html" class="code" title="function [Tn_y,Th_d,Tb_h] = basicTransforms (delta,phi)">basicTransforms</a> (s.nacelle.delta,s.driveshaft.phi);
0077 
0078 Nb  = a.Nb;
0079 Neb = a.Neb;
0080 Nae = Nb*Neb;
0081 
0082 Nmud = s.foundation.Nmud;
0083 Nwater = s.foundation.Nwater;
0084 
0085 <span class="comment">% Load the operating-point state vector and closed-loop matrices</span>
0086 <span class="comment">% based on the default controller.</span>
0087 txt = inpnm;
0088 <span class="keyword">if</span> (Vmag &gt;= 10)
0089    Vstr = [<span class="string">'V'</span> int2str(10*Vmag)];
0090 <span class="keyword">else</span>
0091    Vstr = [<span class="string">'V0'</span> int2str(10*Vmag)];
0092 <span class="keyword">end</span>
0093 
0094 eval([&quot;load <span class="string">'xpsi&quot; txt Vstr &quot;.txt'</span>;&quot;]);
0095 eval([&quot;load <span class="string">'dxpsi&quot; txt Vstr &quot;.txt'</span>;&quot;]);
0096 eval([&quot;load <span class="string">'Rgrav&quot; txt Vstr &quot;.txt'</span>;&quot;]);
0097 eval([&quot;load <span class="string">'ypsi&quot; txt Vstr &quot;.txt'</span>;&quot;]);
0098 eval([&quot;load <span class="string">'upsi&quot; txt Vstr &quot;.txt'</span>;&quot;]);
0099 eval([&quot;load <span class="string">'Lpsi&quot; txt Vstr &quot;.bin'</span>;&quot;]);
0100 eval([&quot;load <span class="string">'Apsi&quot; txt Vstr &quot;.bin'</span>;&quot;]);
0101 eval([&quot;load <span class="string">'Bpsi&quot; txt Vstr &quot;.bin'</span>;&quot;]);
0102 eval([&quot;load <span class="string">'Cpsi&quot; txt Vstr &quot;.bin'</span>;&quot;]);
0103 eval([&quot;load <span class="string">'Dpsi&quot; txt Vstr &quot;.bin'</span>;&quot;]);
0104 eval([&quot;load <span class="string">'dret&quot; txt Vstr &quot;.bin'</span>;&quot;]);
0105 eval([&quot;load <span class="string">'shape&quot; txt Vstr &quot;.bin'</span>;&quot;]);
0106 eval([&quot;load <span class="string">'mdamp&quot; txt Vstr &quot;.bin'</span>;&quot;]);
0107 eval([&quot;load <span class="string">'bldof&quot; txt Vstr &quot;.bin'</span>;&quot;]);
0108 eval([&quot;xpsi = xpsi&quot; txt Vstr &quot;;&quot;]);
0109 eval([&quot;dxpsi = dxpsi&quot; txt Vstr &quot;;&quot;]);
0110 eval([&quot;Rgrav = Rgrav&quot; txt Vstr &quot;;&quot;]);
0111 eval([&quot;ypsi = ypsi&quot; txt Vstr &quot;;&quot;]);
0112 eval([&quot;upsi = upsi&quot; txt Vstr &quot;;&quot;]);
0113 
0114 blxdof = cell2mat (bldof(1));
0115 bludof = cell2mat (bldof(2));
0116 blydof = cell2mat (bldof(3));
0117 
0118 Nx = size(xpsi,1);
0119 Ny = size(ypsi,1);
0120 Neta = 6 + s.foundation.Nmod + s.tower.Nmod + s.nacelle.Nmod <span class="keyword">...</span>
0121      + s.driveshaft.Nmod + s.blade(1).Nmod + s.blade(2).Nmod <span class="keyword">...</span>
0122      + s.blade(3).Nmod + 6;
0123 Nret = size(dret,1);
0124 
0125 iW = 2*Neta - 4;
0126 WW = xpsi(iW);
0127 a3P = 3*WW;
0128 
0129 Nacp = size(a.icp,1);
0130 Nxa = 7*3*Nacp;
0131 
0132 <span class="comment">% Get aero mode shapes.</span>
0133 qpsi   = ypsi(1:Ndj);
0134 qdpsi  = ypsi(Ndj+[1:Ndj]);
0135 qddpsi = ypsi(2*Ndj+[1:Ndj]);
0136 Fpsi   = ypsi(3*Ndj+[1:Ndj]);
0137 [b1,b2,b3] = <a href="../../STAS-WPP/STAS-Aeroelastic/MBCindices_Ndj.html" class="code" title="function [b1,b2,b3] = MBCindices_Ndj (Ndj,idofs)">MBCindices_Ndj</a> (Ndj,idofs);
0138 [TpsiB_Ndj,TBpsi_Ndj] = <a href="../../STAS-WPP/STAS-Utilities/MBC.html" class="code" title="function [TpsiB,TBpsi] = MBC (N,b1,b2,b3,psi)">MBC</a> (Ndj,b1,b2,b3,azi);
0139 q   = TpsiB_Ndj*qpsi;
0140 qd  = TpsiB_Ndj*qdpsi;
0141 Psia = <a href="getPsia.html" class="code" title="function Psia = getPsia (modalAero,s,a,azi,q,qd,P,shape0)">getPsia</a> (0,s,a,azi,q,qd,P,shape0);
0142 
0143 <span class="comment">% Prepare the selected inputs: Pc from the plant control, rotor-</span>
0144 <span class="comment">% average wind speed and direction, waterline wave force, and</span>
0145 <span class="comment">% terminal voltage.</span>
0146 iuPc = Ndj + Neta + 3*Nae + 5;
0147 inVx = Ndj + Neta + [1:3:3*Neb-2].';  <span class="comment">% Collective components.</span>
0148 inVy = Ndj + Neta + [2:3:3*Neb-1].';
0149 inwx = 6*(Nmud+Nwater-1) + 1;
0150 inwy = 6*(Nmud+Nwater-1) + 2;
0151 iuvs = Ndj + Neta + 3*Nae + [3:4].';
0152 
0153 Nu = 6;
0154 
0155 BB = sparse(Nx,Nu);
0156 D0 = sparse(Ny,Nu);
0157 BB(:,1) = Bpsi(:,iuPc);
0158 D0(:,1) = Dpsi(:,iuPc);
0159 mag = sqrt(Vg0(1)^2 + Vg0(2)^2);
0160 ang = atan2(Vg0(2),Vg0(1));
0161 ca = cos(ang);
0162 sa = sin(ang);
0163 BB(:,2:3) = [sum(Bpsi(:,inVx),2) sum(Bpsi(:,inVy),2)]*[ca, -mag*sa;sa, mag*ca];
0164 D0(:,2:3) = [sum(Dpsi(:,inVx),2) sum(Dpsi(:,inVy),2)]*[ca, -mag*sa;sa, mag*ca];
0165 mag = sqrt(Fw0(1)^2 + Fw0(2)^2);
0166 ang = atan2(Fw0(2),Fw0(1));
0167 ca = cos(ang);
0168 sa = sin(ang);
0169 BB(:,4) = [Bpsi(:,inwx) Bpsi(:,inwy)]*[ca;sa];
0170 D0(:,4) = [Dpsi(:,inwx) Dpsi(:,inwy)]*[ca;sa];
0171 BB(:,5:6) = Bpsi(:,iuvs);
0172 D0(:,5:6) = Dpsi(:,iuvs);
0173 
0174 <span class="comment">% Prepare the selected outputs:</span>
0175 <span class="comment">% Sensors: W, beta0, yaw, Pe, vnac, V, thV.</span>
0176 <span class="comment">% Other outputs: a, FT, Pa, qfnd, qbl, ist. (Ignore Qa for the present study.)</span>
0177 ielf = Nmud + 1;
0178 ifnd = idofs(1) + 6*(ielf-1) + [1:12].';
0179 
0180 ielb = 1;
0181 ibld = zeros(12,3);
0182 ibld(:,1) = idofs(6) + 6*(ielb-1) + [1:12].';
0183 ibld(:,2) = idofs(7) + 6*(ielb-1) + [1:12].';
0184 ibld(:,3) = idofs(8) + 6*(ielb-1) + [1:12].';
0185 
0186 Nyo = 61;
0187 CCy = sparse(Nyo,Nx);
0188 DDy = sparse(Nyo,Nu);
0189 
0190 CCy(1,iW) = 1;                  <span class="comment">% Rotor speed.</span>
0191 CCy(2,2*Neta+Nxa+1) = 1;        <span class="comment">% Collective pitch.</span>
0192 CCy(3,2*Neta+Nxa+7) = 1;        <span class="comment">% Yaw.</span>
0193 CCy(4,2*Neta+Nxa+8+25+15) = 1;  <span class="comment">% Electric power.</span>
0194 CCy(5,2*Neta+Nxa+8+25+19) = 1;  <span class="comment">% vnac,x.</span>
0195 CCy(6,2*Neta+Nxa+8+25+22) = 1;  <span class="comment">% vnac,y.</span>
0196 DDy(7,2) = 1;                   <span class="comment">% V.</span>
0197 DDy(8,3) = 1;                   <span class="comment">% thV.</span>
0198 
0199 <span class="comment">% da = (-1/V0) dVi + (Vi0/V0^2) dV*.</span>
0200 <span class="comment">% This is complicated by the fact that the aero states are transformed.</span>
0201 <span class="comment">% Transform the collective part back to element-by-element, and average</span>
0202 <span class="comment">% over the swept area.</span>
0203 rbel = s.driveshaft.Lh + 0.5*a.Lel(1) <span class="keyword">...</span>
0204      + [0;cumsum(0.5*(a.Lel(1:Neb-1)+a.Lel(2:Neb)))];
0205 r2 = rbel.^2;  <span class="comment">% Weight according to swept area, proportional to r^2.</span>
0206 sr2 = sum(r2);
0207 wgt = r2/sr2;
0208 PsiVi = Psia(6:7:7*Neb-1,6:7:(Nxa/3)-1);
0209 ind = 2*Neta + [6:7:(Nxa/3)-1].';
0210 CCy(9,ind) = -sum(full(PsiVi).*wgt)/Vg0(1);
0211 Vi0 = PsiVi*xpsi(ind);
0212 Viavg = sum(Vi0.*wgt);
0213 DDy(9,2) = Viavg/(Vg0(1)^2);
0214 
0215 <span class="comment">% Rotor thrust.</span>
0216 ind = 3*Ndj+[1:Ndj];
0217 FB = TpsiB_Ndj*ypsi(ind);
0218 CFB = TpsiB_Ndj*Cpsi(ind,:);    <span class="comment">% Note, rows are now body, columns (states)</span>
0219 CqB = TpsiB_Ndj*Cpsi(1:Ndj,:);  <span class="comment">% are still MBC.</span>
0220 DFB = TpsiB_Ndj*D0(ind,:);
0221 
0222 FT = zeros(3*s.blade(1).Nnod,1);
0223 [Tn_y,Th_d,Tb_h] = <a href="../../STAS-WPP/STAS-Aeroelastic/basicTransforms.html" class="code" title="function [Tn_y,Th_d,Tb_h] = basicTransforms (delta,phi)">basicTransforms</a> (s.nacelle.delta,s.driveshaft.phi);
0224 Td_n = [cp0 -sp0 0;sp0 cp0 0;0 0 1];
0225 Try = Tn_y;
0226 [Tyy0,dTyy0] = <a href="../../STAS-WPP/STAS-Aeroelastic/dTdth.html" class="code" title="function [T,dT] = dTdth (th)">dTdth</a> (q(idofs(3)+[4:6]));
0227 Ty0g = <a href="../../STAS-WPP/STAS-Utilities/TFromTheta.html" class="code" title="function T = TFromTheta (th)">TFromTheta</a> (P(idofs(3)+[4:6]));
0228 <span class="keyword">for</span> ibl = 1:3
0229 
0230    jcn = s.blade(1).Nnod*(ibl-1);
0231 
0232    bldof = idofs(5+ibl);
0233    [Tpp0,dTpp0] = <a href="../../STAS-WPP/STAS-Aeroelastic/dTdth.html" class="code" title="function [T,dT] = dTdth (th)">dTdth</a> (q(bldof+[4:6]));
0234    Tp0g = <a href="../../STAS-WPP/STAS-Utilities/TFromTheta.html" class="code" title="function T = TFromTheta (th)">TFromTheta</a> (P(bldof+[4:6]));
0235 
0236    indF = bldof + [1:6*s.blade(1).Nnod].';
0237    indy = 3*Ndj + indF;
0238 
0239    TT = ((Ty0g*Tyy0*Try).')*Tp0g*Tpp0;
0240    <span class="keyword">for</span> inod = 2:s.blade(1).Nnod
0241       ic6 = 6*(inod-1);
0242       ic3 = 3*(inod-1);
0243       Fr = TT*FB(indF(ic6+[1:3]));
0244       FT(jcn+inod) = Fr(3);
0245 
0246       CCy(10,:) = CCy(10,:)                                 <span class="keyword">...</span>
0247                 + [0 0 1]*TT*CFB(indF(ic6+[1:3]),:);
0248       DDy(10,:) = DDy(10,:)                                 <span class="keyword">...</span>
0249                 + [0 0 1]*TT*DFB(indF(ic6+[1:3]),:);
0250 
0251       <span class="keyword">for</span> jj = 1:3
0252          jc3 = 3*(jj-1);
0253          CCy(10,:) = CCy(10,:)                                           <span class="keyword">...</span>
0254                    + [0 0 1]*((Ty0g*dTyy0(:,jc3+[1:3])*Try).')           <span class="keyword">...</span>
0255                    * Tp0g*Tpp0*FB(indF(ic6+[1:3]))*CqB(idofs(3)+3+jj,:)  <span class="keyword">...</span>
0256                    + [0 0 1]*((Ty0g*Tyy0*Try).')*Tp0g*dTpp0(:,jc3+[1:3]) <span class="keyword">...</span>
0257                    * FB(indF(ic6+[1:3]))*CqB(bldof+3+jj,:);
0258          <span class="comment">% DqB = 0, so no contribution to DDy(10,:).</span>
0259       <span class="keyword">end</span>
0260 
0261    <span class="keyword">end</span>
0262 
0263 <span class="keyword">end</span>
0264 
0265 <span class="comment">% Available power.</span>
0266 DDy(11,2) = CPstar*1.5*dens*Area*Vmag^2;
0267 
0268 <span class="comment">% Foundation and blade root q's.</span>
0269 CCy(12:23,:) = Cpsi(ifnd,:);
0270 CCy(24:35,:) = Cpsi(ibld(:,1),:);
0271 CCy(36:47,:) = Cpsi(ibld(:,2),:);
0272 CCy(48:59,:) = Cpsi(ibld(:,3),:);
0273 
0274 <span class="comment">% Transformer terminal currents.</span>
0275 CCy(60:61,:) = Cpsi(4*Ndj+4+1+[1:2],:);
0276 
0277 <span class="comment">% Eliminate the azimuth DOF.</span>
0278 Nret = size(dret,1);
0279 
0280 LA = Lpsi(dret,dret)\Apsi(dret,dret);
0281 LB = Lpsi(dret,dret)\BB(dret,:);
0282 CC = CCy(:,dret);
0283 DD = DDy;
0284 
0285 fkey = [0.01:0.01:fco].';
0286 tol = 1.e-3;
0287 Yflg = 1;
0288 wrtflg = 1;
0289 [Amod,Bmod,Cmod] = <a href="modalTransformation.html" class="code" title="function [Am,Bm,Cm] = modalTransformation (A,B,C,freqs,tol,Yflg,wrtflg)">modalTransformation</a> (LA,LB,CC,fkey,tol,Yflg,wrtflg);
0290 Nxm = size(Amod,1);
0291 Dmod = DD;
0292 
0293 tol = 1.e-3;
0294 fmatch = [0.01:0.01:fco].';
0295 [Amr,Bmr,Cmr,Dmr] = <a href="modelReduction.html" class="code" title="function [Ar,Br,Cr,Dr] = modelReduction (A,B,C,D,freqs,tol)">modelReduction</a> (Amod,Bmod,Cmod,Dmod,fmatch,tol);
0296 <span class="comment">%Amr = Amod;</span>
0297 <span class="comment">%Bmr = Bmod;</span>
0298 <span class="comment">%Cmr = Cmod;</span>
0299 <span class="comment">%Dmr = Dmod;</span>
0300 Nxred = size(Amr,1);
0301 
0302 eval([&quot;save (<span class="string">'-binary'</span>,<span class="string">'Amod&quot; txt Vstr &quot;.bin'</span>,<span class="string">'Amod'</span>);&quot;]);
0303 eval([&quot;save (<span class="string">'-binary'</span>,<span class="string">'Bmod&quot; txt Vstr &quot;.bin'</span>,<span class="string">'Bmod'</span>);&quot;]);
0304 eval([&quot;save (<span class="string">'-binary'</span>,<span class="string">'Cmod&quot; txt Vstr &quot;.bin'</span>,<span class="string">'Cmod'</span>);&quot;]);
0305 eval([&quot;save (<span class="string">'-binary'</span>,<span class="string">'Dmod&quot; txt Vstr &quot;.bin'</span>,<span class="string">'Dmod'</span>);&quot;]);
0306 eval([&quot;save (<span class="string">'-binary'</span>,<span class="string">'Amr&quot; txt Vstr &quot;.bin'</span>,<span class="string">'Amr'</span>);&quot;]);
0307 eval([&quot;save (<span class="string">'-binary'</span>,<span class="string">'Bmr&quot; txt Vstr &quot;.bin'</span>,<span class="string">'Bmr'</span>);&quot;]);
0308 eval([&quot;save (<span class="string">'-binary'</span>,<span class="string">'Cmr&quot; txt Vstr &quot;.bin'</span>,<span class="string">'Cmr'</span>);&quot;]);
0309 eval([&quot;save (<span class="string">'-binary'</span>,<span class="string">'Dmr&quot; txt Vstr &quot;.bin'</span>,<span class="string">'Dmr'</span>);&quot;]);
0310 
0311 <span class="comment">% Check some TFs.</span>
0312 TFs = zeros(Nf/2,Nyo*Nu);
0313 TFr = zeros(Nf/2,Nyo*Nu);
0314 <span class="keyword">for</span> ifreq = 1:Nf/2
0315 
0316    f = freqs(ifreq);
0317    w = 2*pi*f;
0318 
0319    TF = CC*((i*w*speye(Nret) - LA)\LB) + DD;
0320    TFs(ifreq,:) = reshape(TF,1,Nyo*Nu);
0321 
0322    TF = Cmr*((i*w*speye(Nxred) - Amr)\Bmr) + Dmr;
0323    TFr(ifreq,:) = reshape(TF,1,Nyo*Nu);
0324 
0325 <span class="keyword">end</span>
0326 
0327 iu = 2;  <span class="comment">% 1: Pc, 2: V, 3: thV, 4: Fw, 5-6 vs.</span>
0328 iy = 10;  <span class="comment">% 1: W, 2: beta0, 3: yaw, 4: Pe, 5-6: vnac, 7: V, 8: thV,</span>
0329          <span class="comment">% 9: a, 10: FT, 11: Pa, 12-23: qfnd, 24-59: qbl.</span>
0330 icol = Nyo*(iu-1) + iy;
0331 
0332 figure(1);
0333 clf;
0334 hold on;
0335 semilogy(freqs(2:Nf/2),abs(TFs(2:Nf/2,icol)));
0336 semilogy(freqs(2:Nf/2),abs(TFr(2:Nf/2,icol)));
0337 hold off;
0338 
0339 <span class="comment">% Check eigenvalues of the reduced matrices.</span>
0340 [slap,shp,ifrq] = <a href="../../STAS-WPP/STAS-Utilities/eigVal.html" class="code" title="function [slap,shp,ifrq] = eigVal (A)">eigVal</a> (Amr);
0341 
0342 <span class="comment">% Diagonalize and Y transform.</span>
0343 [AY,BY,CY,Phi,slap] = <a href="../../STAS-WPP/STAS-Main/Ytransform.html" class="code" title="function [A,B,C,Phi,slap] = Ytransform (aa,bb,cc)">Ytransform</a> (Amr,Bmr,Cmr);
0344 DY = Dmr;
0345 
0346 <span class="comment">% Make high-frequency modes quasi-static.</span>
0347 
0348 ind = [1:Nxred].';
0349 jqs = (abs(slap)/(2*pi) &gt; fco);
0350 iqs = ind(jqs);
0351 [Ap,ret,jnk] = <a href="../../STAS-WPP/STAS-Utilities/partitionMatrix.html" class="code" title="function [Mp,rr,cr] = partitionMatrix (M,rDOFs,cDOFs)">partitionMatrix</a> (AY,iqs,iqs);
0352 AA = AY(iqs,iqs)\AY(iqs,ret);
0353 AB = AY(iqs,iqs)\BY(iqs,:);
0354 Aq = AY(ret,ret) - AY(ret,iqs)*AA;
0355 Bq = BY(ret,:) - AY(ret,iqs)*AB;
0356 Cq = CY(:,ret) - CY(:,iqs)*AA;
0357 Dq = DY - CY(:,iqs)*AB;
0358 
0359 <span class="comment">%Aq = AY;</span>
0360 <span class="comment">%Bq = BY;</span>
0361 <span class="comment">%Cq = CY;</span>
0362 <span class="comment">%Dq = DY;</span>
0363 Nxq = size(Aq,1);
0364 
0365 <span class="comment">% Check some more TFs.</span>
0366 TFq = zeros(Nf/2,Nyo*Nu);
0367 <span class="keyword">for</span> ifreq = 1:Nf/2
0368 
0369    f = freqs(ifreq);
0370    w = 2*pi*f;
0371 
0372    TF = Cq*((i*w*speye(Nxq) - Aq)\Bq) + Dq;
0373    TFq(ifreq,:) = reshape(TF,1,Nyo*Nu);
0374 
0375 <span class="keyword">end</span>
0376 
0377 figure(2);
0378 clf;
0379 hold on;
0380 semilogy(freqs(2:Nf/2),abs(TFs(2:Nf/2,icol)));
0381 semilogy(freqs(2:Nf/2),abs(TFr(2:Nf/2,icol)));
0382 semilogy(freqs(2:Nf/2),abs(TFq(2:Nf/2,icol)));
0383 hold off;
0384 
0385 [AT,BT,dt] = <a href="../../STAS-WPP/STAS-Main/SSDiscreteTime.html" class="code" title="function [A,B,dt] = SSDiscreteTime (meth,aa,bb,dti)">SSDiscreteTime</a> (2,Aq,Bq,dt);
0386 [slap,shp,ifrq] = <a href="../../STAS-WPP/STAS-Utilities/eigVal_silent.html" class="code" title="function [slap,shp,ifrq] = eigVal_silent (A)">eigVal_silent</a> (AT);
0387 abs(slap)
0388 
0389 eval([&quot;save (<span class="string">'-binary'</span>,<span class="string">'Aq&quot; txt Vstr &quot;.bin'</span>,<span class="string">'Aq'</span>);&quot;]);
0390 eval([&quot;save (<span class="string">'-binary'</span>,<span class="string">'Bq&quot; txt Vstr &quot;.bin'</span>,<span class="string">'Bq'</span>);&quot;]);
0391 eval([&quot;save (<span class="string">'-binary'</span>,<span class="string">'Cq&quot; txt Vstr &quot;.bin'</span>,<span class="string">'Cq'</span>);&quot;]);
0392 eval([&quot;save (<span class="string">'-binary'</span>,<span class="string">'Dq&quot; txt Vstr &quot;.bin'</span>,<span class="string">'Dq'</span>);&quot;]);
0393 eval([&quot;save (<span class="string">'-binary'</span>,<span class="string">'AT&quot; txt Vstr &quot;.bin'</span>,<span class="string">'AT'</span>);&quot;]);
0394 eval([&quot;save (<span class="string">'-binary'</span>,<span class="string">'BT&quot; txt Vstr &quot;.bin'</span>,<span class="string">'BT'</span>);&quot;]);
0395 
0396 <span class="comment">%{</span>
0397 
0398 <span class="comment">% Check some step functions.</span>
0399 Nt = 600;
0400 yt = zeros(Nt,Nyo*Nu);
0401 xt = zeros(Nxq,Nu);
0402 u  = zeros(Nu,1);
0403 ts = zeros(Nt,1);
0404 <span class="keyword">for</span> it = 2:Nt
0405 
0406    ts(it) = ts(it-1) + dt;
0407 
0408    <span class="keyword">if</span> (it &gt; 10)
0409       u = ones(Nu,1);
0410    <span class="keyword">end</span>
0411    <span class="keyword">for</span> iu = 1:Nu
0412       icn = Nyo*(iu-1);
0413       u1 = zeros(Nu,1);
0414       u1(iu) = u(iu);
0415       xt(:,iu) = AT*xt(:,iu) + BT*u1;
0416       yt(it,icn+[1:Nyo]) = (Cq*xt(:,iu) + Dq*u1).';
0417    <span class="keyword">end</span>
0418 
0419 <span class="keyword">end</span>
0420 
0421 <span class="comment">% u(inputs) : 1: Pc, 2: V, 3: thV, 4: Fw, 5-6: vs</span>
0422 <span class="comment">% y(sensors): 1: W, 2: beta0, 3: yaw, 4: Pe, 5-6: vnac, 7: V, 8: thV</span>
0423 <span class="comment">% y(other)  : 9: a, 10: FT, 11: Pa, 12-23: qfnd, 24-59: qbl.</span>
0424 <span class="keyword">for</span> iu = 1:4
0425    icn = Nyo*(iu-1);
0426    figure(iu+2);
0427    clf;
0428    <span class="keyword">for</span> iyout = 1:8
0429       subplot(2,4,iyout);
0430       hold on;
0431       plot (ts,yt(:,icn+iyout),<span class="string">'color'</span>,[0.0, 0.0, 0.0],<span class="string">'linewidth'</span>,2.0);
0432       hold off;
0433    <span class="keyword">end</span>
0434 <span class="keyword">end</span>
0435 
0436 <span class="comment">%}</span>
</pre></div>

<hr><address>Generated on Wed 28-Feb-2024 10:23:21 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>
