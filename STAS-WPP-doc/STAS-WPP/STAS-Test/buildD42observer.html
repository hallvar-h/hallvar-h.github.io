<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of buildD42observer</title>
  <meta name="keywords" content="buildD42observer">
  <meta name="description" content="">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../index.html">Home</a> &gt;  <a href="../index.html">STAS-WPP</a> &gt; <a href="index.html">STAS-Test</a> &gt; buildD42observer.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../index.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for STAS-WPP\STAS-Test&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>buildD42observer
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong></strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>This is a script file. </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment"></pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="../../STAS-WPP/STAS-Aeroelastic/MBCindices_Ndj.html" class="code" title="function [b1,b2,b3] = MBCindices_Ndj (Ndj,idofs)">MBCindices_Ndj</a>	</li>
<li><a href="../../STAS-WPP/STAS-Aeroelastic/assemblePin.html" class="code" title="function Pin = assemblePin (s)">assemblePin</a>	Version:        Changes:</li>
<li><a href="../../STAS-WPP/STAS-Aeroelastic/basicTransforms.html" class="code" title="function [Tn_y,Th_d,Tb_h] = basicTransforms (delta,phi)">basicTransforms</a>	This builds the basic 3-by-3 transform matrices,</li>
<li><a href="../../STAS-WPP/STAS-Aeroelastic/dTdth.html" class="code" title="function [T,dT] = dTdth (th)">dTdth</a>	</li>
<li><a href="../../STAS-WPP/STAS-Aeroelastic/getDOFRefs.html" class="code" title="function [idofs,idofm,inods,inodm,Ndof] = getDOFRefs (s)">getDOFRefs</a>	</li>
<li><a href="../../STAS-WPP/STAS-Aeroelastic/getmdofRefs.html" class="code" title="function [imdofs,Nmd] = getmdofRefs (s)">getmdofRefs</a>	</li>
<li><a href="../../STAS-WPP/STAS-Aeroelastic/undeformedPosition.html" class="code" title="function [qB0,Pn0_B,Ts0_B,TB0_g] =undeformedPosition (Pin,yaw,tilt,azimuth,cone,pitch,edx,idofs,idofm,inods,inodm)">undeformedPosition</a>	</li>
<li><a href="../../STAS-WPP/STAS-Electric/inductance.html" class="code" title="function [L,dL] = inductance (I0,L0,II)">inductance</a>	</li>
<li><a href="../../STAS-WPP/STAS-Main/SSDiscreteTime.html" class="code" title="function [A,B,dt] = SSDiscreteTime (meth,aa,bb,dti)">SSDiscreteTime</a>	</li>
<li><a href="../../STAS-WPP/STAS-Main/Ytransform.html" class="code" title="function [A,B,C,Phi,slap] = Ytransform (aa,bb,cc)">Ytransform</a>	</li>
<li><a href="getPsia.html" class="code" title="function Psia = getPsia (modalAero,s,a,azi,q,qd,P,shape0)">getPsia</a>	</li>
<li><a href="modalTransformation.html" class="code" title="function [Am,Bm,Cm] = modalTransformation (A,B,C,freqs,tol,Yflg,wrtflg)">modalTransformation</a>	</li>
<li><a href="modelReduction.html" class="code" title="function [Ar,Br,Cr,Dr] = modelReduction (A,B,C,D,freqs,tol)">modelReduction</a>	</li>
<li><a href="../../STAS-WPP/STAS-Utilities/MBC.html" class="code" title="function [TpsiB,TBpsi] = MBC (N,b1,b2,b3,psi)">MBC</a>	</li>
<li><a href="../../STAS-WPP/STAS-Utilities/TFromTheta.html" class="code" title="function T = TFromTheta (th)">TFromTheta</a>	</li>
<li><a href="../../STAS-WPP/STAS-Utilities/eigVal.html" class="code" title="function [slap,shp,ifrq] = eigVal (A)">eigVal</a>	</li>
<li><a href="../../STAS-WPP/STAS-Utilities/eigVal_silent.html" class="code" title="function [slap,shp,ifrq] = eigVal_silent (A)">eigVal_silent</a>	</li>
<li><a href="../../STAS-WPP/STAS-Utilities/getLTMnorms.html" class="code" title="function [length,time,mass,current,voltage,velocity,force,power,stress,ndens,nvisc,stiffness,damping,resistance,inductance,capacitance,flux] = getLTMnorms (fname)">getLTMnorms</a>	</li>
<li><a href="../../STAS-WPP/STAS-Utilities/partitionMatrix.html" class="code" title="function [Mp,rr,cr] = partitionMatrix (M,rDOFs,cDOFs)">partitionMatrix</a>	</li>
</ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
</ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 
0002 clear;
0003 
0004 pkg load statistics;
0005 pkg load control;
0006 
0007 [length,time,mass,current,voltage,              <span class="keyword">...</span>
0008  velocity,force,power,stress,density,viscosity, <span class="keyword">...</span>
0009  stiffness,damping,resistance,<a href="../../STAS-WPP/STAS-Electric/inductance.html" class="code" title="function [L,dL] = inductance (I0,L0,II)">inductance</a>,       <span class="keyword">...</span>
0010  capacitance,flux] = <a href="../../STAS-WPP/STAS-Utilities/getLTMnorms.html" class="code" title="function [length,time,mass,current,voltage,velocity,force,power,stress,ndens,nvisc,stiffness,damping,resistance,inductance,capacitance,flux] = getLTMnorms (fname)">getLTMnorms</a> (<span class="string">'LTMnorms.txt'</span>);
0011 
0012 <span class="comment">%load 'Sij_V10_I183_Lu180_Y0.bin';</span>
0013 <span class="comment">%load 'Sijp_V10_I183_Lu180_Y0.bin';</span>
0014 <span class="comment">%load 'cvg_V10_I183_Lu180_Y0.bin';</span>
0015 <span class="comment">%load 'Vavg_V10_I183_Lu180_Y0.bin';</span>
0016 
0017 <span class="comment">%load 'Savg_Hs20_TP6.bin';</span>
0018 
0019 nm = <span class="string">'DTU10MW'</span>;
0020 inpnm = <span class="string">'_P060_'</span>;
0021 
0022 modalAero = 0;
0023 
0024 Vmag = 10                                   / (length/time);
0025 thV = 0;
0026 Vg0 = [Vmag*cos(thV); Vmag*sin(thV); 0];
0027 dens = 1.225                                / density;
0028 Area = pi*(89.15^2)                         / length^2;
0029 CPstar = 0.48;
0030 
0031 yaw = 0;
0032 betas = [0;0;0];
0033 azi = 0;
0034 cp0 = cos(azi);
0035 sp0 = sin(azi);
0036 
0037 Tpw = 6                                     / time;
0038 Hsw = 2                                     / length;
0039 wang = 0;
0040 fw = 1/Tpw;
0041 aw = 2*pi*fw;
0042 zetw = 0.1;
0043 atw = 0.01*(2*pi);
0044 Fw0 = 1e6*[cos(wang), sin(wang)].'          / force;
0045 
0046 aV = 0.05*(2*pi)                            * time;
0047 <span class="comment">% a3P computed based on W.</span>
0048 zet3P = 0.1;
0049 
0050 fco = 0.5                                   * time;  <span class="comment">% &gt; fco solved as static.</span>
0051 dt = 0.05                                   / time;  <span class="comment">% Set to -1 for auto.</span>
0052 
0053 Nsp = 7; <span class="comment">% Get stresses at Nsp points over a quadrant of the circumference.</span>
0054 ths = (pi/12)*[0:Nsp-1].';
0055 ct = cos(ths);
0056 st = sin(ths);
0057 
0058 Nf = 2^12;  <span class="comment">% = 4*nnf, that is, 4 times the number of analysis frequencies.</span>
0059 df = 0.001                                  * time;
0060 
0061 freqs = df*[[0:Nf/2-1] [-Nf/2:-1]].';
0062 
0063 eval([<span class="string">'[s,a] = STASTurbine_'</span>  nm <span class="string">' ();'</span>]);
0064 eval([<span class="string">'epar  = STASElectric_'</span> nm <span class="string">' ();'</span>]);
0065 eval([<span class="string">'ppar  = STASPitch_'</span>    nm <span class="string">' ();'</span>]);
0066 eval([<span class="string">'ypar  = STASYaw_'</span>      nm <span class="string">' ();'</span>]);
0067 eval([<span class="string">'c     = STASControl_'</span>  nm <span class="string">' ();'</span>]);
0068 
0069 [idofs,idofm,inods,inodm,Ndof] = <a href="../../STAS-WPP/STAS-Aeroelastic/getDOFRefs.html" class="code" title="function [idofs,idofm,inods,inodm,Ndof] = getDOFRefs (s)">getDOFRefs</a> (s);
0070 [imdofs,Nmd] = <a href="../../STAS-WPP/STAS-Aeroelastic/getmdofRefs.html" class="code" title="function [imdofs,Nmd] = getmdofRefs (s)">getmdofRefs</a> (s);
0071 Ndj = Ndof + 6;
0072 Nnod = Ndof/6;
0073 
0074 Pin = <a href="../../STAS-WPP/STAS-Aeroelastic/assemblePin.html" class="code" title="function Pin = assemblePin (s)">assemblePin</a> (s);
0075 [jnkq,P,Ts0_B,TB0_g] =                                                  <span class="keyword">...</span>
0076       <a href="../../STAS-WPP/STAS-Aeroelastic/undeformedPosition.html" class="code" title="function [qB0,Pn0_B,Ts0_B,TB0_g] =undeformedPosition (Pin,yaw,tilt,azimuth,cone,pitch,edx,idofs,idofm,inods,inodm)">undeformedPosition</a> (Pin,yaw,s.nacelle.delta,azi,s.driveshaft.phi, <span class="keyword">...</span>
0077                           betas,0,idofs,idofm,inods,inodm);
0078 
0079 Nb  = a.Nb;
0080 Neb = a.Neb;
0081 Nae = Nb*Neb;
0082 
0083 Nmud = s.foundation.Nmud;
0084 Nwater = s.foundation.Nwater;
0085 
0086 <span class="comment">% Load the operating-point state vector and matrices.</span>
0087 txt = inpnm;
0088 <span class="keyword">if</span> (Vmag &gt;= 10)
0089    Vstr = [<span class="string">'V'</span> int2str(round(10*Vmag))];
0090 <span class="keyword">else</span>
0091    Vstr = [<span class="string">'V0'</span> int2str(round(10*Vmag))];
0092 <span class="keyword">end</span>
0093 eval([&quot;load <span class="string">'xop&quot; txt Vstr &quot;.txt'</span>;&quot;]);
0094 eval([&quot;load <span class="string">'yop&quot; txt Vstr &quot;.txt'</span>;&quot;]);
0095 eval([&quot;load <span class="string">'Lop&quot; txt Vstr &quot;.bin'</span>;&quot;]);
0096 eval([&quot;load <span class="string">'Aop&quot; txt Vstr &quot;.bin'</span>;&quot;]);
0097 eval([&quot;load <span class="string">'Bop&quot; txt Vstr &quot;.bin'</span>;&quot;]);
0098 eval([&quot;load <span class="string">'Cop&quot; txt Vstr &quot;.bin'</span>;&quot;]);
0099 eval([&quot;load <span class="string">'Dop&quot; txt Vstr &quot;.bin'</span>;&quot;]);
0100 eval([&quot;load <span class="string">'shape&quot; txt Vstr &quot;.bin'</span>;&quot;]);
0101 eval([&quot;load <span class="string">'bldof&quot; txt Vstr &quot;.bin'</span>;&quot;]);
0102 eval([&quot;xop = xop&quot; txt Vstr &quot;;&quot;]);
0103 eval([&quot;yop = yop&quot; txt Vstr &quot;;&quot;]);
0104 
0105 blxdof = cell2mat (bldof(1));
0106 bludof = cell2mat (bldof(2));
0107 blydof = cell2mat (bldof(3));
0108 
0109 Nx = size(xop,1);
0110 Ny = size(yop,1);
0111 Neta = 6 + s.foundation.Nmod + s.tower.Nmod + s.nacelle.Nmod <span class="keyword">...</span>
0112      + s.driveshaft.Nmod + s.blade(1).Nmod + s.blade(2).Nmod <span class="keyword">...</span>
0113      + s.blade(3).Nmod + 6;
0114 
0115 iW = 2*Neta - 4;
0116 WW = xop(iW);
0117 a3P = 3*WW;
0118 
0119 <span class="keyword">if</span> (modalAero == 1)
0120    a.icp = [-1;-3];
0121 <span class="keyword">end</span>
0122 Nacp = size(a.icp,1);
0123 Nxa = 7*3*Nacp;
0124 
0125 <span class="comment">% Get aero mode shapes.</span>
0126 qpsi   = yop(1:Ndj);
0127 qdpsi  = yop(Ndj+[1:Ndj]);
0128 qddpsi = yop(2*Ndj+[1:Ndj]);
0129 Fpsi   = yop(3*Ndj+[1:Ndj]);
0130 [b1,b2,b3] = <a href="../../STAS-WPP/STAS-Aeroelastic/MBCindices_Ndj.html" class="code" title="function [b1,b2,b3] = MBCindices_Ndj (Ndj,idofs)">MBCindices_Ndj</a> (Ndj,idofs);
0131 [TpsiB_Ndj,TBpsi_Ndj] = <a href="../../STAS-WPP/STAS-Utilities/MBC.html" class="code" title="function [TpsiB,TBpsi] = MBC (N,b1,b2,b3,psi)">MBC</a> (Ndj,b1,b2,b3,azi);
0132 q   = TpsiB_Ndj*qpsi;
0133 qd  = TpsiB_Ndj*qdpsi;
0134 Psia = <a href="getPsia.html" class="code" title="function Psia = getPsia (modalAero,s,a,azi,q,qd,P,shape0)">getPsia</a> (modalAero,s,a,azi,q,qd,P,shape0);
0135 
0136 <span class="comment">% Prepare the observer inputs: P, beta, yaw from the plant control,</span>
0137 <span class="comment">% rotor-average wind speed and direction, and waterline wave force.</span>
0138 iuP  = Ndj + Neta + 3*Nae + 4 + 8 + 1;
0139 iub  = Ndj + Neta + 3*Nae + 1;
0140 iuy  = Ndj + Neta + 3*Nae + 4;
0141 inVx = Ndj + Neta + [1:3:3*Neb-2].';  <span class="comment">% Collective components.</span>
0142 inVy = Ndj + Neta + [2:3:3*Neb-1].';
0143 inwx = 6*(Nmud+Nwater-1) + 1;
0144 inwy = 6*(Nmud+Nwater-1) + 2;
0145 
0146 Nu = 6;
0147 
0148 BB = sparse(Nx,Nu);
0149 DDy = sparse(Ny,Nu);
0150 BB (:,1) = Bop(:,iuP);
0151 DDy(:,1) = Dop(:,iuP);
0152 BB (:,2) = Bop(:,iub);
0153 DDy(:,2) = Dop(:,iub);
0154 BB (:,3) = Bop(:,iuy);
0155 DDy(:,3) = Dop(:,iuy);
0156 mag = sqrt(Vg0(1)^2 + Vg0(2)^2);
0157 ang = atan2(Vg0(2),Vg0(1));
0158 ca = cos(ang);
0159 sa = sin(ang);
0160 BB(:,4:5) = [sum(Bop(:,inVx),2) sum(Bop(:,inVy),2)]*[ca, -mag*sa;sa, mag*ca];
0161 DDy(:,4:5) = [sum(Dop(:,inVx),2) sum(Dop(:,inVy),2)]*[ca, -mag*sa;sa, mag*ca];
0162 mag = sqrt(Fw0(1)^2 + Fw0(2)^2);
0163 ang = atan2(Fw0(2),Fw0(1));
0164 ca = cos(ang);
0165 sa = sin(ang);
0166 BB(:,6) = [Bop(:,inwx) Bop(:,inwy)]*[ca;sa];
0167 DDy(:,6) = [Dop(:,inwx) Dop(:,inwy)]*[ca;sa];
0168 
0169 <span class="comment">% Augment the matrices with the environmental models.</span>
0170 a32 = a3P^2;
0171 tza = 2*zet3P*a3P;
0172 aw2 = aw^2;
0173 tzaw = 2*zetw*aw;
0174 aae = [-aV, 0,    0,    0,    0,    0; <span class="keyword">...</span>
0175        0, -aV,    0,    0,    0,    0; <span class="keyword">...</span>
0176        0,   0,    0,    1,    0,    0; <span class="keyword">...</span>
0177        0,   0, -a32, -tza,    0,    0; <span class="keyword">...</span>
0178        0,   0,    0,    0,    0,    1; <span class="keyword">...</span>
0179        0,   0,    0,    0, -aw2, -tzaw];
0180 bbe = [aV,  0,  0; <span class="keyword">...</span>
0181        0,  aV,  0; <span class="keyword">...</span>
0182        0,   0,  0; <span class="keyword">...</span>
0183        tza, 0,  0; <span class="keyword">...</span>
0184        0,   0,  0; <span class="keyword">...</span>
0185        0,   0,  tzaw];
0186 
0187 Nxe = size(aae,1);
0188 Nxaug = Nx + Nxe;
0189 Laug = sparse(Nxaug,Nxaug);
0190 Aaug = sparse(Nxaug,Nxaug);
0191 Baug = sparse(Nxaug,Nu);
0192 Caug = sparse(Ny,Nxaug);
0193 Aaug(1:Nx,1:Nx) = Aop;
0194 Laug(1:Nx,1:Nx) = Lop;
0195 Baug(1:Nx,1:3) = BB(:,1:3);         <span class="comment">% Only the control columns.</span>
0196 Caug(:,1:Nx) = Cop;
0197 Aaug(Nx+[1:Nxe],Nx+[1:Nxe]) = aae;
0198 Baug(Nx+[1:Nxe],4:6) = bbe;         <span class="comment">% External V,thV,Fw feed the env model.</span>
0199 Aaug(1:Nx,Nx+1) = BB(:,4);          <span class="comment">% Env model x feeds the rest of the model.</span>
0200 Aaug(1:Nx,Nx+2) = BB(:,5);
0201 <span class="comment">%Aaug(1:Nx,Nx+4) = BB(:,4);</span>
0202 Aaug(1:Nx,Nx+6) = BB(:,6);
0203 Caug(:,Nx+1) = DDy(:,4);
0204 Caug(:,Nx+2) = DDy(:,5);
0205 <span class="comment">%Caug(:,Nx+4) = DDy(:,4);</span>
0206 Caug(:,Nx+6) = DDy(:,6);
0207 Laug(Nx+[1:Nxe],Nx+[1:Nxe]) = speye(Nxe);
0208 
0209 <span class="comment">% Prepare the observer outputs:</span>
0210 <span class="comment">% Sensors: W, beta0, yaw, Pe, vnac, V, thV.</span>
0211 <span class="comment">% Other outputs: a, FT, Pa, qfnd, qbl. (Ignore Qa for the present study.)</span>
0212 ielf = Nmud + 1;
0213 ifnd = idofs(1) + 6*(ielf-1) + [1:12].';
0214 
0215 ielb = 1;
0216 ibld = zeros(12,3);
0217 ibld(:,1) = idofs(6) + 6*(ielb-1) + [1:12].';
0218 ibld(:,2) = idofs(7) + 6*(ielb-1) + [1:12].';
0219 ibld(:,3) = idofs(8) + 6*(ielb-1) + [1:12].';
0220 
0221 Nyo = 61;
0222 ccy = sparse(Nyo,Nxaug);
0223 
0224 ind = 2*Neta + Nxa + 8 + 25 + [1, 2, 5, 6, 7, 8, 9, 10].';
0225 ccy(1:8,ind) = speye(8);
0226 
0227 <span class="comment">% da = (-1/V0) dVi + (Vi0/V0^2) dV*.</span>
0228 <span class="comment">% This is complicated by the fact that the aero states are transformed.</span>
0229 <span class="comment">% Transform the collective part back to element-by-element, and average</span>
0230 <span class="comment">% over the swept area.</span>
0231 rbel = s.driveshaft.Lh + 0.5*a.Lel(1) <span class="keyword">...</span>
0232      + [0;cumsum(0.5*(a.Lel(1:Neb-1)+a.Lel(2:Neb)))];
0233 r2 = rbel.^2;  <span class="comment">% Weight according to swept area, proportional to r^2.</span>
0234 sr2 = sum(r2);
0235 wgt = r2/sr2;
0236 PsiVi = Psia(6:7:7*Neb-1,6:7:(Nxa/3)-1);
0237 ind = 2*Neta + [6:7:(Nxa/3)-1].';
0238 ccy(9,ind) = -sum(full(PsiVi).*wgt)/Vg0(1);
0239 Vi0 = PsiVi*xop(ind);
0240 Viavg = sum(Vi0.*wgt);
0241 ind = Nx + 1; <span class="comment">% V*</span>
0242 ccy(9,ind) = Viavg/(Vg0(1)^2);
0243 
0244 <span class="comment">% Rotor thrust.</span>
0245 ind = 3*Ndj+[1:Ndj];
0246 FB = TpsiB_Ndj*yop(ind);
0247 CFB = TpsiB_Ndj*Caug(ind,:);    <span class="comment">% Note, rows are now body, columns (states)</span>
0248 CqB = TpsiB_Ndj*Caug(1:Ndj,:);  <span class="comment">% are still MBC.</span>
0249 DFB = TpsiB_Ndj*DDy(ind,:);
0250 
0251 FT = zeros(3*s.blade(1).Nnod,1);
0252 [Tn_y,Th_d,Tb_h] = <a href="../../STAS-WPP/STAS-Aeroelastic/basicTransforms.html" class="code" title="function [Tn_y,Th_d,Tb_h] = basicTransforms (delta,phi)">basicTransforms</a> (s.nacelle.delta,s.driveshaft.phi);
0253 Td_n = [cp0 -sp0 0;sp0 cp0 0;0 0 1];
0254 Try = Tn_y;
0255 [Tyy0,dTyy0] = <a href="../../STAS-WPP/STAS-Aeroelastic/dTdth.html" class="code" title="function [T,dT] = dTdth (th)">dTdth</a> (q(idofs(3)+[4:6]));
0256 Ty0g = <a href="../../STAS-WPP/STAS-Utilities/TFromTheta.html" class="code" title="function T = TFromTheta (th)">TFromTheta</a> (P(idofs(3)+[4:6]));
0257 <span class="keyword">for</span> ibl = 1:3
0258 
0259    jcn = s.blade(1).Nnod*(ibl-1);
0260 
0261    bldof = idofs(5+ibl);
0262    [Tpp0,dTpp0] = <a href="../../STAS-WPP/STAS-Aeroelastic/dTdth.html" class="code" title="function [T,dT] = dTdth (th)">dTdth</a> (q(bldof+[4:6]));
0263    Tp0g = <a href="../../STAS-WPP/STAS-Utilities/TFromTheta.html" class="code" title="function T = TFromTheta (th)">TFromTheta</a> (P(bldof+[4:6]));
0264 
0265    indF = bldof + [1:6*s.blade(1).Nnod].';
0266    indy = 3*Ndj + indF;
0267 
0268    TT = ((Ty0g*Tyy0*Try).')*Tp0g*Tpp0;
0269    <span class="keyword">for</span> inod = 2:s.blade(1).Nnod
0270       ic6 = 6*(inod-1);
0271       ic3 = 3*(inod-1);
0272       Fr = TT*FB(indF(ic6+[1:3]));
0273       FT(jcn+inod) = Fr(3);
0274 
0275       ccy(10,:) = ccy(10,:)                                 <span class="keyword">...</span>
0276                 + [0 0 1]*TT*CFB(indF(ic6+[1:3]),:);
0277 <span class="comment">% Is this double-counting?  Already put DDy's in Caug.</span>
0278 <span class="comment">%      ccy(10,Nx+1) = ccy(10,Nx+1)                           ...  % V</span>
0279 <span class="comment">%                   + [0 0 1]*TT*DFB(indF(ic6+[1:3]),4);</span>
0280 <span class="comment">%      ccy(10,Nx+4) = ccy(10,Nx+4)                           ...  % V3P</span>
0281 <span class="comment">%                + [0 0 1]*TT*DFB(indF(ic6+[1:3]),4);</span>
0282 
0283       <span class="keyword">for</span> jj = 1:3
0284          jc3 = 3*(jj-1);
0285          ccy(10,:) = ccy(10,:)                                           <span class="keyword">...</span>
0286                    + [0 0 1]*((Ty0g*dTyy0(:,jc3+[1:3])*Try).')           <span class="keyword">...</span>
0287                    * Tp0g*Tpp0*FB(indF(ic6+[1:3]))*CqB(idofs(3)+3+jj,:)  <span class="keyword">...</span>
0288                    + [0 0 1]*((Ty0g*Tyy0*Try).')*Tp0g*dTpp0(:,jc3+[1:3]) <span class="keyword">...</span>
0289                    * FB(indF(ic6+[1:3]))*CqB(bldof+3+jj,:);
0290          <span class="comment">% DqB = 0, so no additional contribution.</span>
0291       <span class="keyword">end</span>
0292 
0293    <span class="keyword">end</span>
0294 
0295 <span class="keyword">end</span>
0296 
0297 <span class="comment">% Available power.</span>
0298 ind = 2*Neta + Nxa + 8 + 25 + 9;
0299 ccy(11,ind) = CPstar*1.5*dens*Area*(xop(ind)^2);
0300 
0301 <span class="comment">% Foundation and blade root q's.</span>
0302 ccy(12:23,:) = Caug(ifnd,:);
0303 ccy(24:35,:) = Caug(ibld(:,1),:);
0304 ccy(36:47,:) = Caug(ibld(:,2),:);
0305 ccy(48:59,:) = Caug(ibld(:,3),:);
0306 
0307 <span class="comment">% Transformer terminal currents.</span>
0308 ccy(60:61,:) = Caug(4*Ndj+4+1+[1:2],:);
0309 
0310 <span class="comment">% Eliminate the azimuth DOF.</span>
0311 dret = [[1:Neta-6] Neta-[5 3 2 1 0] [(Neta+1):Nxaug]].';
0312 Nret = size(dret,1);
0313 
0314 LA = Laug(dret,dret)\Aaug(dret,dret);
0315 LB = Laug(dret,dret)\Baug(dret,:);
0316 CC = ccy(:,dret);
0317 
0318 fkey = [0.01:0.01:fco].';
0319 tol = 1.e-4;
0320 Yflg = 1;
0321 wrtflg = 1;
0322 [Aobs,Bobs,Cobs] = <a href="modalTransformation.html" class="code" title="function [Am,Bm,Cm] = modalTransformation (A,B,C,freqs,tol,Yflg,wrtflg)">modalTransformation</a> (LA,LB,CC,fkey,tol,Yflg,wrtflg);
0323 <span class="comment">%Aobs = LA;</span>
0324 <span class="comment">%Bobs = LB;</span>
0325 <span class="comment">%Cobs = CC;</span>
0326 Dobs = sparse(size(Cobs,1),size(Bobs,2));
0327 Nxm = size(Aobs,1);
0328 
0329 tol = 1.e-3;
0330 fmatch = [0.01:0.01:fco].';
0331 [Ared,Bred,Cred,Dred] = <a href="modelReduction.html" class="code" title="function [Ar,Br,Cr,Dr] = modelReduction (A,B,C,D,freqs,tol)">modelReduction</a> (Aobs,Bobs,Cobs,Dobs,fmatch,tol);
0332 <span class="comment">%Ared = Aobs;</span>
0333 <span class="comment">%Bred = Bobs;</span>
0334 <span class="comment">%Cred = Cobs;</span>
0335 <span class="comment">%Dred = Dobs;</span>
0336 Nxred = size(Ared,1);
0337 
0338 eval([&quot;save (<span class="string">'-binary'</span>,<span class="string">'Aobs&quot; txt Vstr &quot;.bin'</span>,<span class="string">'Aobs'</span>);&quot;]);
0339 eval([&quot;save (<span class="string">'-binary'</span>,<span class="string">'Bobs&quot; txt Vstr &quot;.bin'</span>,<span class="string">'Bobs'</span>);&quot;]);
0340 eval([&quot;save (<span class="string">'-binary'</span>,<span class="string">'Cobs&quot; txt Vstr &quot;.bin'</span>,<span class="string">'Cobs'</span>);&quot;]);
0341 eval([&quot;save (<span class="string">'-binary'</span>,<span class="string">'Dobs&quot; txt Vstr &quot;.bin'</span>,<span class="string">'Dobs'</span>);&quot;]);
0342 eval([&quot;save (<span class="string">'-binary'</span>,<span class="string">'Ared&quot; txt Vstr &quot;.bin'</span>,<span class="string">'Ared'</span>);&quot;]);
0343 eval([&quot;save (<span class="string">'-binary'</span>,<span class="string">'Bred&quot; txt Vstr &quot;.bin'</span>,<span class="string">'Bred'</span>);&quot;]);
0344 eval([&quot;save (<span class="string">'-binary'</span>,<span class="string">'Cred&quot; txt Vstr &quot;.bin'</span>,<span class="string">'Cred'</span>);&quot;]);
0345 eval([&quot;save (<span class="string">'-binary'</span>,<span class="string">'Dred&quot; txt Vstr &quot;.bin'</span>,<span class="string">'Dred'</span>);&quot;]);
0346 
0347 <span class="comment">%{</span>
0348 
0349 <span class="comment">% Check some TFs.</span>
0350 TFs = zeros(Nf/2,Nyo*Nu);
0351 TFr = zeros(Nf/2,Nyo*Nu);
0352 <span class="keyword">for</span> ifreq = 1:Nf/2
0353 
0354    f = freqs(ifreq);
0355    w = 2*pi*f;
0356 
0357 <span class="comment">%   TF = Cobs*((i*w*speye(Nxm) - Aobs)\Bobs) + Dobs;</span>
0358 <span class="comment">%   TFs(ifreq,:) = reshape(TF,1,Nyo*Nu);</span>
0359 
0360    TF = CC*((i*w*speye(Nret) - LA)\LB);
0361    TFs(ifreq,:) = reshape(TF,1,Nyo*Nu);
0362 
0363    TF = Cred*((i*w*speye(Nxred) - Ared)\Bred) + Dred;
0364    TFr(ifreq,:) = reshape(TF,1,Nyo*Nu);
0365 
0366 <span class="keyword">end</span>
0367 
0368 <span class="comment">% 1: Pc, 2: beta, 3: yaw, 4: V, 5: thV, 6: Fw.</span>
0369 <span class="comment">% 1: W, 2: beta0, 3: yaw, 4: Pe, 5-6: vnac, 7: V, 8: thV,</span>
0370 <span class="comment">% 9: a, 10: FT, 11: Pa, 12-23: qfnd, 24-59: qbl.</span>
0371 <span class="keyword">for</span> iu = 1:6
0372 
0373    icn = Nyo*(iu-1);
0374 
0375    figure(iu);
0376    clf;
0377    subplot(2,2,1)
0378    hold on;
0379    semilogy(freqs(2:Nf/2),abs(TFs(2:Nf/2,icn+[1, 2, 3])), <span class="keyword">...</span>
0380             <span class="string">'color'</span>,[0, 0, 0],<span class="string">'linewidth'</span>,3.0);
0381    semilogy(freqs(2:Nf/2),abs(TFr(2:Nf/2,icn+[1, 2, 3])), <span class="keyword">...</span>
0382             <span class="string">'color'</span>,[0.6, 0.6, 0.6],<span class="string">'linewidth'</span>,2.0);
0383    hold off;
0384    subplot(2,2,2)
0385    hold on;
0386    semilogy(freqs(2:Nf/2),abs(TFs(2:Nf/2,icn+[4, 9, 10, 11])), <span class="keyword">...</span>
0387             <span class="string">'color'</span>,[0, 0, 0],<span class="string">'linewidth'</span>,3.0);
0388    semilogy(freqs(2:Nf/2),abs(TFr(2:Nf/2,icn+[4, 9, 10, 11])), <span class="keyword">...</span>
0389             <span class="string">'color'</span>,[0.6, 0.6, 0.6],<span class="string">'linewidth'</span>,2.0);
0390    hold off;
0391    subplot(2,2,3)
0392    hold on;
0393    semilogy(freqs(2:Nf/2),abs(TFs(2:Nf/2,icn+[5:8])), <span class="keyword">...</span>
0394             <span class="string">'color'</span>,[0, 0, 0],<span class="string">'linewidth'</span>,3.0);
0395    semilogy(freqs(2:Nf/2),abs(TFr(2:Nf/2,icn+[5:8])), <span class="keyword">...</span>
0396             <span class="string">'color'</span>,[0.6, 0.6, 0.6],<span class="string">'linewidth'</span>,2.0);
0397    hold off;
0398    subplot(2,2,4)
0399    hold on;
0400    semilogy(freqs(2:Nf/2),abs(TFs(2:Nf/2,icn+[36:41])), <span class="keyword">...</span>
0401             <span class="string">'color'</span>,[0, 0, 0],<span class="string">'linewidth'</span>,3.0);
0402    semilogy(freqs(2:Nf/2),abs(TFr(2:Nf/2,icn+[36:41])), <span class="keyword">...</span>
0403             <span class="string">'color'</span>,[0.6, 0.6, 0.6],<span class="string">'linewidth'</span>,2.0);
0404    hold off;
0405 
0406 <span class="keyword">end</span>
0407 
0408 <span class="comment">%}</span>
0409 
0410 <span class="comment">% Check eigenvalues of the reduced matrices.</span>
0411 [slap,shp,ifrq] = <a href="../../STAS-WPP/STAS-Utilities/eigVal.html" class="code" title="function [slap,shp,ifrq] = eigVal (A)">eigVal</a> (Ared);
0412 
0413 <span class="comment">% Diagonalize and Y transform.</span>
0414 [AY,BY,CY,Phi,slap] = <a href="../../STAS-WPP/STAS-Main/Ytransform.html" class="code" title="function [A,B,C,Phi,slap] = Ytransform (aa,bb,cc)">Ytransform</a> (Ared,Bred,Cred);
0415 DY = Dred;
0416 
0417 <span class="comment">% Make high-frequency modes quasi-static.</span>
0418 
0419 ind = [1:Nxred].';
0420 jqs = (abs(slap)/(2*pi) &gt; fco);
0421 iqs = ind(jqs);
0422 [Ap,ret,jnk] = <a href="../../STAS-WPP/STAS-Utilities/partitionMatrix.html" class="code" title="function [Mp,rr,cr] = partitionMatrix (M,rDOFs,cDOFs)">partitionMatrix</a> (AY,iqs,iqs);
0423 AA = AY(iqs,iqs)\AY(iqs,ret);
0424 AB = AY(iqs,iqs)\BY(iqs,:);
0425 Ao = AY(ret,ret) - AY(ret,iqs)*AA;
0426 Bo = BY(ret,:) - AY(ret,iqs)*AB;
0427 Co = CY(:,ret) - CY(:,iqs)*AA;
0428 Do = DY - CY(:,iqs)*AB;
0429 
0430 <span class="comment">%Ao = AY;</span>
0431 <span class="comment">%Bo = BY;</span>
0432 <span class="comment">%Co = CY;</span>
0433 <span class="comment">%Do = DY;</span>
0434 Nxo = size(Ao,1);
0435 
0436 <span class="comment">%{</span>
0437 
0438 <span class="comment">% Check some more TFs.</span>
0439 TFq = zeros(Nf/2,Nyo*Nu);
0440 <span class="keyword">for</span> ifreq = 1:Nf/2
0441 
0442    f = freqs(ifreq);
0443    w = 2*pi*f;
0444 
0445    TF = Co*((i*w*speye(Nxo) - Ao)\Bo) + Do;
0446    TFq(ifreq,:) = reshape(TF,1,Nyo*Nu);
0447 
0448 <span class="keyword">end</span>
0449 
0450 <span class="keyword">for</span> iu = 1:6
0451 
0452    icn = Nyo*(iu-1);
0453 
0454    figure(iu+6);
0455    clf;
0456    subplot(2,2,1)
0457    hold on;
0458    semilogy(freqs(2:Nf/2),abs(TFs(2:Nf/2,icn+[1, 2, 3])), <span class="keyword">...</span>
0459             <span class="string">'color'</span>,[0, 0, 0],<span class="string">'linewidth'</span>,3.0);
0460    semilogy(freqs(2:Nf/2),abs(TFq(2:Nf/2,icn+[1, 2, 3])), <span class="keyword">...</span>
0461             <span class="string">'color'</span>,[0.6, 0.6, 0.6],<span class="string">'linewidth'</span>,2.0);
0462    hold off;
0463    subplot(2,2,2)
0464    hold on;
0465    semilogy(freqs(2:Nf/2),abs(TFs(2:Nf/2,icn+[4, 9, 10, 11])), <span class="keyword">...</span>
0466             <span class="string">'color'</span>,[0, 0, 0],<span class="string">'linewidth'</span>,3.0);
0467    semilogy(freqs(2:Nf/2),abs(TFq(2:Nf/2,icn+[4, 9, 10, 11])), <span class="keyword">...</span>
0468             <span class="string">'color'</span>,[0.6, 0.6, 0.6],<span class="string">'linewidth'</span>,2.0);
0469    hold off;
0470    subplot(2,2,3)
0471    hold on;
0472    semilogy(freqs(2:Nf/2),abs(TFs(2:Nf/2,icn+[5:8])), <span class="keyword">...</span>
0473             <span class="string">'color'</span>,[0, 0, 0],<span class="string">'linewidth'</span>,3.0);
0474    semilogy(freqs(2:Nf/2),abs(TFq(2:Nf/2,icn+[5:8])), <span class="keyword">...</span>
0475             <span class="string">'color'</span>,[0.6, 0.6, 0.6],<span class="string">'linewidth'</span>,2.0);
0476    hold off;
0477    subplot(2,2,4)
0478    hold on;
0479    semilogy(freqs(2:Nf/2),abs(TFs(2:Nf/2,icn+[36:41])), <span class="keyword">...</span>
0480             <span class="string">'color'</span>,[0, 0, 0],<span class="string">'linewidth'</span>,3.0);
0481    semilogy(freqs(2:Nf/2),abs(TFq(2:Nf/2,icn+[36:41])), <span class="keyword">...</span>
0482             <span class="string">'color'</span>,[0.6, 0.6, 0.6],<span class="string">'linewidth'</span>,2.0);
0483    hold off;
0484 
0485 <span class="keyword">end</span>
0486 
0487 <span class="comment">%}</span>
0488 
0489 [ADT,BDT,dt] = <a href="../../STAS-WPP/STAS-Main/SSDiscreteTime.html" class="code" title="function [A,B,dt] = SSDiscreteTime (meth,aa,bb,dti)">SSDiscreteTime</a> (2,Ao,Bo,dt);
0490 [slap,shp,ifrq] = <a href="../../STAS-WPP/STAS-Utilities/eigVal_silent.html" class="code" title="function [slap,shp,ifrq] = eigVal_silent (A)">eigVal_silent</a> (ADT);
0491 abs(slap)
0492 
0493 eval([&quot;save (<span class="string">'-binary'</span>,<span class="string">'Ao&quot; txt Vstr &quot;.bin'</span>,<span class="string">'Ao'</span>);&quot;]);
0494 eval([&quot;save (<span class="string">'-binary'</span>,<span class="string">'Bo&quot; txt Vstr &quot;.bin'</span>,<span class="string">'Bo'</span>);&quot;]);
0495 eval([&quot;save (<span class="string">'-binary'</span>,<span class="string">'Co&quot; txt Vstr &quot;.bin'</span>,<span class="string">'Co'</span>);&quot;]);
0496 eval([&quot;save (<span class="string">'-binary'</span>,<span class="string">'Do&quot; txt Vstr &quot;.bin'</span>,<span class="string">'Do'</span>);&quot;]);
0497 eval([&quot;save (<span class="string">'-binary'</span>,<span class="string">'ADT&quot; txt Vstr &quot;.bin'</span>,<span class="string">'ADT'</span>);&quot;]);
0498 eval([&quot;save (<span class="string">'-binary'</span>,<span class="string">'BDT&quot; txt Vstr &quot;.bin'</span>,<span class="string">'BDT'</span>);&quot;]);
0499 
0500 <span class="comment">%{</span>
0501 
0502 <span class="comment">% Check some step functions.</span>
0503 Nt = 600;
0504 yo = zeros(Nt,Nyo*Nu);
0505 xo = zeros(Nxo,Nu);
0506 u  = zeros(Nu,1);
0507 ts = zeros(Nt,1);
0508 <span class="keyword">for</span> it = 2:Nt
0509 
0510    ts(it) = ts(it-1) + dt;
0511 
0512    <span class="keyword">if</span> (it &gt; 10)
0513       u = ones(Nu,1);
0514    <span class="keyword">end</span>
0515    <span class="keyword">for</span> iu = 1:Nu
0516       icn = Nyo*(iu-1);
0517       u1 = zeros(Nu,1);
0518       u1(iu) = u(iu);
0519       xo(:,iu) = ADT*xo(:,iu) + BDT*u1;
0520       yo(it,icn+[1:Nyo]) = (Co*xo(:,iu) + Do*u1).';
0521    <span class="keyword">end</span>
0522 
0523 <span class="keyword">end</span>
0524 
0525 <span class="comment">% 1: Pc, 2: beta, 3: yaw, 4: V, 5: thV, 6: Fw.</span>
0526 <span class="comment">% y(sensors): 1: W, 2: beta0, 3: yaw, 4: Pe, 5-6: vnac, 7: V, 8: thV</span>
0527 <span class="comment">% y(other)  : 9: a, 10: FT, 11: Pa, 12-23: qfnd, 24-59: qbl.</span>
0528 <span class="keyword">for</span> iu = 1:6
0529    icn = Nyo*(iu-1);
0530    figure(iu+12);
0531    clf;
0532    <span class="keyword">for</span> iyout = 1:8
0533       subplot(2,4,iyout);
0534       hold on;
0535       plot (ts,yo(:,icn+iyout),<span class="string">'color'</span>,[0.0, 0.0, 0.0],<span class="string">'linewidth'</span>,2.0);
0536       hold off;
0537    <span class="keyword">end</span>
0538 <span class="keyword">end</span>
0539 
0540 <span class="comment">%}</span>
</pre></div>

<hr><address>Generated on Wed 28-Feb-2024 10:23:21 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>
